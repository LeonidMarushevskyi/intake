#!/usr/bin/env ruby
require 'pry'
$stdout.sync = true

require "shellwords"

ENV["RAILS_ENV"] ||= "test"
RAILS_ENV = ENV["RAILS_ENV"]

ENV["NODE_ENV"] ||= RAILS_ENV
NODE_ENV = ENV["NODE_ENV"]

APP_PATH          = File.expand_path("../", __dir__)
NODE_MODULES_PATH = File.join(APP_PATH, "node_modules")
WEBPACK_CONFIG    = File.join(APP_PATH, "config/webpack/#{NODE_ENV}.js")

unless File.exist?(WEBPACK_CONFIG)
  puts "Webpack configuration not found."
  puts "Please run bundle exec rails webpacker:install to install webpacker"
  exit!
end

newenv  = { "NODE_PATH" => NODE_MODULES_PATH.shellescape }
cmdline = ['bin/webpack; ./node_modules/.bin/karma start ./config/karma.conf.js'] + ARGV

Dir.chdir(APP_PATH) do
  exec newenv, *cmdline
end

#!/bin/bash
#bin/gulp build-test-assets

# Tests must be run in the correct timezone because
# of UTC converstion and explicit expectations.
# Sincerely,
# The Time Lords
export TZ=Etc/GMT+7

if [[ "$GENERATE_TEST_REPORTS" = 'yes' ]]; then
  exec ./node_modules/.bin/karma start karma.conf.js --reporters junit,dots,coverage,karma-remap-istanbul $options "$@"
else
  exec ./node_modules/.bin/karma start karma.conf.js --reporters dots $options "$@"
fi
